---
title: "CARDIA-ADPQS-replication"
author: "LekkiWood (LekkiWood@Gmail.com)"
date: today
format:
  pdf:
    pdf-engine: lualatex
    includes:
      in_header: 'gt_packages.sty'
    header-includes:
      - \usepackage{pdflscape}
      - \setkeys{Gin}{width=\linewidth,height=0.9\textheight,keepaspectratio}
    toc: true
    toc-depth: 4
crossref:
  tbl-prefix: "Table"
  fig-prefix: "Figure"
execute:
  echo: false
  warning: false
  message: false
  # ensure chunks run from the project root (where _targets/ lives)
  dir: project
pdf-engine: lualatex
editor: visual
---

```{r}

#| label: load-packages
#| cache: true


## Load targets
if (!requireNamespace("targets", quietly = TRUE)) {
  stop("The {targets} package is not installed/available in this render session.")
}

## Load knitr
if (!requireNamespace("knitr", quietly = TRUE)) {
  stop("The {knitr} package is not installed/available in this render session.")
}

## Load quarto
if (!requireNamespace("quarto", quietly = TRUE)) {
  stop("The {quarto} package is not installed/available in this render session.")
}

## Load gtsummary
if (!requireNamespace("gtsummary", quietly = TRUE)) {
  stop("The {gtsummary} package is not installed/available in this render session.")
}

## Load ggplot
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  stop("The {ggplot2} package is not installed/available in this render session.")
}

## Load ggrepel
if (!requireNamespace("ggrepel", quietly = TRUE)) {
  stop("The {ggrepel} package is not installed/available in this render session.")
}

## Load naniar
if (!requireNamespace("naniar", quietly = TRUE)) {
  stop("The {naniar} package is not installed/available in this render session.")
}

## Load interactions
if (!requireNamespace("interactions", quietly = TRUE)) {
  stop("The {naniar} package is not installed/available in this render session.")
}

## Load MLM
if (!requireNamespace("lme4", quietly = TRUE)) {
  stop("The {naniar} package is not installed/available in this render session.")
}

## Load Venn
if (!requireNamespace("VennDiagram", quietly = TRUE)) {
  stop("The {VennDiagram} package is not installed/available in this render session.")
}

## Load Scales
if (!requireNamespace("scales", quietly = TRUE)) {
  stop("The {VennDiagram} package is not installed/available in this render session.")
}

## Load Survival
if (!requireNamespace("survival", quietly = TRUE)) {
  stop("The {VennDiagram} package is not installed/available in this render session.")
}
```

\newpage

# Important Notes - read me first

## Version control

-   Always check that you have the most recent version of this document, which - unless I am sending you unfinalized work - is available [here](https://github.com/LekkiWood/CARDIA-ADPQS-replication/blob/main/CARDIA-ADPQS-replication.pdf).

-   An easy check for version control is to make sure this date: `r Sys.Date()`. is the same as on the GitHub file [here](https://github.com/LekkiWood/CARDIA-ADPQS-replication/blob/main/CARDIA-ADPQS-replication.pdf).

-   The code for this is analysis available in the same repository ([targets master file here](https://github.com/LekkiWood/CARDIA-ADPQS-replication/blob/main/_targets.R) and [individual functions here](https://github.com/LekkiWood/CARDIA-ADPQS-replication/tree/main/R))

# Step 1: Cleaning and Formatting Proteins

```{r}
#| label: load-filename-info
#| cache: true

#General QC info
QC_info <- targets::tar_read(build_proteins_QC)

#Final N
finalclean_N_by_exam <- targets::tar_read(Proteins_clean_N)
```

## Input file names

-   A table of protein abundances: `{r} print(unlist(strsplit(QC_info$filenames$raw_proteins_file_name, split="/"))[8])`
-   Sample information to link TOPMed IDs to unique MESA SHARe ID and exam combinations: `{r} print(unlist(strsplit(QC_info$filenames$raw_protein_info_file_name, split="/"))[8])`
-   Keys to link Olink IDs to names compounds: `{r} print(unlist(strsplit(QC_info$filenames$ raw_protein_keys_file_name, split="/"))[8])`
-   A file to bridge SHARe ids (sidno) with MESA IDs (idno) `{r} print(unlist(strsplit(QC_info$filenames$raw_bridgingfile_file_name, split="/"))[7])`

## Raw file info

-   The raw protein abundance file contained information on N=`{r} print(QC_info$raw_inputs$raw_protein_N_all)` protein assays, including those used for QC.

-   When removing assays for QC, the raw protein abundance file contained information on N=`{r} print(QC_info$raw_inputs$raw_protein_N_proteins[1,1])` proteins.

-   The protein abundance file contained information on N=`{r} print(QC_info$raw_inputs$raw_N_all)` sample IDs (i.e., unique participant/exam combinations), including bridging samples.

-   After removing QC samples (including bridging, controls, and one duplicate) the protein abundance file contained information on N=`{r} print(QC_info$raw_inputs$raw_N_nobridge)` sample IDs (i.e., unique participant/exam combinations).

### Formatting

-   Bridging (and other QC) samples were removed.

-   Protein assays used for QC were removed.

-   Proteins that should be excluded due to QC warnings (variable "QC_warning" set to "EXCLUDED") were removed, even though these do not have NPX values.

-   Data were put into wide format, with "SampleID" as the unique ID, "OlinkID" forming the variable names (protein identifiers), and values taken from the "NPX" column.

-   In wide format, the file contained information on N=`{r} print(QC_info$formatted_protein_file_info$unique_sampleids)` unique sample IDs.

-   In wide format, the file contained information on N=`{r} print(QC_info$formatted_protein_file_info$duplicated_sampleids)` duplicated sample IDs. ^1^

-   SHARe IDs, and subsequently MESA IDs, were merged into the file with exam information.

-   At this point, the range of unique SHARe ID by exam combinations was N=`{r} range(QC_info$initial_dupes$Freq)[1]` - `{r} range(QC_info$initial_dupes$Freq)[2]`. This indicates no sample ID were duplicated in the assays.

-   The formatted protein file was used to calculate the coefficient of variation (CV) using the formula: CV = sqrt(2`^`(sigma`^`2)-1).

-   A variable called "Retain" was created to indicate whether each protein was (1) unique (i.e., included on only one panel); (2) duplicated, and across all panels had the lowest CV; or (3) duplicated, and across all panels did not have the lowest CV.

-   A final table of protein abundances, with additional variables for SHARe ID, MESA ID, Exam, TOPMed ID and Batch, was created after the steps above, with proteins duplicated across more than one panel cleaned such that only the one with the lowest CV is retained. This file was used in the analysis

-   The number of participants, stratified by exam, in the final file is available in @tbl-final-N-by-exam:

```{r}
#| label: tbl-final-N-by-exam
#| tbl-cap: Final N by exam
#| cache: true

knitr::kable(finalclean_N_by_exam, format="latex") 
```

\newpage

# Step 2: Build traits

```{r}
#| label: read-in-trait-info

Traits_QC_info <- targets::tar_read(traits_QC_info)
Traits_db <- targets::tar_read(traits_db)

```

## Input files

-   Covariates `{r} print(base::unlist(base::strsplit(Traits_QC_info$filenames$E1_covs_filename, split="/"))[7])`
-   Diet data (for exclusions) `{r} print(unlist(strsplit(Traits_QC_info$filenames$E1_nutr_filename, split="/"))[7])`
-   Incident events `{r} print(unlist(strsplit(Traits_QC_info$filenames$cvd_filename, split="/"))[7])`

## Coding

### Outcomes

-   CVD event data was time to any hard CVD event, as defined by MESA.
-   The total number of person years included in the analysis is `{r} print(sum(Traits_db$cvdhtt, na.rm=TRUE)/365)`.

### Covariates

-   Race was coded as a factor variable; coded 1= European-American, 2 = Chinese-American, 3 = African-American, 4 = Hispanic-American
-   Sex was coded as a factor variable; coded 1 = female, 2 = male
-   Age was baseline age
-   BMI was baseline BMI in kg/m2 with height and weight taken by trained study staff
-   Diabetes was binary; 1 = no diabetes, 2 = diabetes according to ADA 2003 criteria (fasting glucose, use of medication, self-reported diagnosis) and so includes both treated and untreated diabetes
-   Smoking is a continuous variable of pack years smoked over the lifetime at baseline
-   Physical activity (PA) is total moderate of vigorous physical activity in Met-Min / week
-   Caloric intake (energy) is calories / day
-   eGFR is eGFR at baseline
-   Systolic blood pressure was taken seated at baseline
-   HDL is HDL-C in mg/dL at baseline
-   Total cholesterol is is mg/dL at baseline
-   Use of hypertension medication is a factor variable; coded 0 = No, 1 = yes
-   Use of cholesterol lowering medication is a factor variable for use of any lipid-lowerting medication; coded 0 = No, 1 = yes

Note: Visceral fat was not available

## Sample description

-   There are N=`{r} print(length(unique(Traits_QC_info$IDs$protein_ids$idno)))` individuals with Olink protein data at exam 1.
-   Of these, N=`{r} print(length(unique(Traits_QC_info$IDs$nocvd_ids$idno)))` individuals did not have CVD data, leaving a sample of N=`{r} print(length(unique(Traits_QC_info$IDs$cvd_ids$idno)))`
-   Of these, N=`{r} print(length(unique(Traits_QC_info$IDs$nodiet_ids$idno)))` individuals did not have diet data, and a further N=`{r} print(length(unique(Traits_QC_info$IDs$highenergy_ids$idno)))` had diet data outside the acceptable range (800-8000 kcals / day for men, 600-6000 kcals / day for women) leaving a sample of N=`{r} print(length(unique(Traits_QC_info$IDs$diet_ids$idno)))`.
-   Sample descriptives are available in @tbl-of-descriptives

::: landscape
```{r}
#| label: tbl-of-descriptives
#| tbl-cap: Sample Descriptives


bold_labels <- c(
  "Age (y)", "Gender", "Race or ethnicity", "BMI (kg/m^2^)", "Physical activity (MET-min/week)", "Caloric intake (kcals/day)", "Kidney function (egfr)", "Systolic blood pressure (mmHg)", "HDL-cholesterol (mg/dL)", "Smoking history (lifetime pack years)", "Diabetes status", "Total cholesterol (mg/dL)", "Takes hypertentsion medicine", "Takes lipid-lowering medicine", "Experienced a hard CVD event", "Mean follow-up time (days)", "Mean follow-up time (years)"
  )

table1 <- Traits_db |> 
  dplyr::mutate(
        gender_desc = factor(sex,
                       levels = c("1", "2"),
                       labels = c("Female", "Male")),
        race_desc = factor(race,
                       levels = c("1", "2", "3", "4"),
                       labels = c("Non-Hispanic White", "Chinese American", "Black/African-American", "Hispanic")),
        diabetes_desc = factor(diabetes,
                               levels = c("0", "1"),
                               labels = c("Normoglycemia/IFG", "Diabetes (treated or untreated)")),
        htnmeds_desc = factor(htnmeds,
                       levels = c("0", "1"),
                       labels = c("No", "Yes")),
        lipidmeds_desc = factor(lipidmeds,
                       levels = c("0", "1"),
                       labels = c("No", "Yes")),
        cvd_desc = factor(cvdh,
                       levels = c("0", "1"),
                       labels = c("No", "Yes")),
        cvdhtt_years = cvdhtt/365
                       ) |>
          gtsummary::tbl_summary(
            include = c(age, gender_desc, race_desc, BMI, PA, energy, eGFR, SBP, HDL, smoking, diabetes_desc, cholesterol, htnmeds_desc, lipidmeds_desc, cvd_desc, cvdhtt, cvdhtt_years),
            statistic = list(
              gtsummary::all_continuous() ~ "{mean} ({sd})",
              gtsummary::all_categorical() ~ "{n} / {N} ({p}%)"
              ), 
            missing = "no", # don't list missing data separately
            digits = gtsummary::all_continuous() ~ 2, 
            label = list(age = "Age (y)",
                 gender_desc = "Gender",
                 race_desc = "Race or ethnicity",
                 BMI = "BMI (kg/m^2^)",
                 PA = "Physical activity (MET-min/week)",
                 energy = "Caloric intake (kcals/day)",
                 eGFR = "Kidney function (egfr)",
                 SBP = "Systolic blood pressure (mmHg)",
                 HDL = "HDL-cholesterol (mg/dL)",
                 smoking = "Smoking history (lifetime pack years)",
                 diabetes_desc = "Diabetes status",
                 cholesterol = "Total cholesterol (mg/dL)",
                 htnmeds_desc = "Takes hypertentsion medicine",
                 lipidmeds_desc = "Takes lipid-lowering medicine",
                 cvd_desc = "Experienced a hard CVD event",
                 cvdhtt = "Mean follow-up time (days)",
                 cvdhtt_years = "Mean follow-up time (years)"
            ),
             type = list(age ~ "continuous",
                 gender_desc ~ "categorical",
                 race_desc ~ "categorical",
                 BMI ~ "continuous",
                 PA ~ "continuous",
                 energy ~ "continuous",
                 eGFR ~ "continuous",
                 SBP ~ "continuous",
                 HDL ~ "continuous",
                 smoking ~ "continuous",
                 diabetes_desc ~ "categorical",
                 cholesterol ~ "continuous",
                 htnmeds_desc ~ "categorical",
                 lipidmeds_desc ~ "categorical",
                 cvd_desc ~ "categorical",
                 cvdhtt ~ "continuous",
                 cvdhtt_years ~ "continuous"
             )
          ) |>
  gtsummary::modify_spanning_header(
    gtsummary::all_stat_cols() ~ "Exam"
  ) |>
  gtsummary::as_gt() |>
  gt::tab_options(page.orientation = "landscape") |>
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_body(
      columns = "label",
      rows = label %in% bold_labels
    )
    ) |>
# Bold *any* spanning headers 
  gt::tab_style(
    style = gt::cell_text(weight = "bold"),
    locations = gt::cells_column_spanners()
  ) |>
  gt::tab_options(latex.use_longtable = TRUE)

table1

rm(bold_labels)
rm(table1)


```
:::

# Step 3: Build Scores

```{r}
#| label: read-in-score-info
#| cache: TRUE

#Files
betas_file <- targets::tar_read(path_betas)
#Score info
APDQS_QC_info <- targets::tar_read(APDQS_QC_info)
plant_QC_info <- targets::tar_read(plant_QC_info)
meat_QC_info <- targets::tar_read(meat_QC_info)


scores <- (targets::tar_read(APDQS_protein_scores) |> dplyr::filter(! is.na(idno))) |>
  dplyr::full_join((targets::tar_read(meat_protein_scores) |> dplyr::filter(! is.na(idno))), dplyr::join_by(idno, Exam)) |>
  dplyr::full_join((targets::tar_read(plant_protein_scores) |> dplyr::filter(! is.na(idno))), dplyr::join_by(idno, Exam)) |>
  dplyr::filter(Exam==1) |>
  dplyr::select(-Exam) |>
  dplyr::left_join((Traits_db |> 
                      dplyr::mutate(idno = as.factor(idno))), dplyr::join_by(idno))
```

## Input files

Weights from the LASSO model were taken from the following file: `{r} print(unlist(strsplit(betas_file, split="/"))[6])`

## Create scores

Three scores were created:

1.  ADPQS score

  -   The LASSO file included N=`{r} APDQS_QC_info$Sig_targets_n` proteins selected as variables of importance to  ADPQS scores in the LASSO (N=`{r} APDQS_QC_info$Duplicate_targets_n` duplicate OlinkIDs). 
  -   N=`{r} length(APDQS_QC_info$Included_targets)` of these proteins were available in MESA and included in the score. 

2.  Meat score

  -   The LASSO file included N=`{r} meat_QC_info$Sig_targets_n` proteins selected as variables of importance to "Mea" scores in the LASSO (N=`{r} meat_QC_info$Duplicate_targets_n` duplicate OlinkIDs). 
  -   N=`{r} length(meat_QC_info$Included_targets)` of these proteins were available in MESA and included in the scotre. 

3.  Plant score

  -   The LASSO file included N=`{r} plant_QC_info$Sig_targets_n` proteins selected as variables of importance to "Plant" scores in the LASSO (N=`{r} plant_QC_info$Duplicate_targets_n` duplicate OlinkIDs). 
  -   N=`{r} length(plant_QC_info$Included_targets)` of these proteins were available in MESA and included in the score.
  

# Step 4: Associations of Scores with CVD

-   Separate cox-proportional hazards models were run for each protein score with time to CVD (hard). 
-   All continuous variables were standardized
-   For the minimally adjusted models, data were included from N=`{r} survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(APDQS_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy), data = scores)$n` individuals.
-   For the fully adjusted models, data were included from N=`{r} survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(APDQS_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy) + scale(smoking) + scale(SBP) + scale(HDL) + scale(cholesterol) + factor(diabetes) + factor(htnmeds) + factor(lipidmeds), data = scores)$n` individuals.
-   Estimates for the minimally adjusted models are in @tbl-cox-min
-   Estimates for the fully adjusted models are in @tbl-cox-full





    
:::landscape
```{r}
#| label: tbl-cox-min
#| tbl-cap: "Cox Proportional Hazards Models (minimally adjusted)"
#| echo: false
#| message: false


# Fit model

fitdata <- scores |>
  dplyr::mutate(
        sex = factor(sex,
                       levels = c("1", "2"),
                       labels = c("Female", "Male")),
         race = factor(race,
                       levels = c("1", "2", "3", "4"),
                       labels = c("Non-Hispanic White", "Chinese American", "Black/African-American", "Hispanic")),
        diabetes = factor(diabetes,
                               levels = c("0", "1"),
                               labels = c("Normoglycemia/IFG", "Diabetes (treated or untreated)")),
        htnmeds = factor(htnmeds,
                       levels = c("0", "1"),
                       labels = c("No", "Yes")),
        lipidmeds = factor(lipidmeds,
                       levels = c("0", "1"),
                       labels = c("No", "Yes"))
  )

fit1 <- survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(APDQS_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy), data = fitdata) |>
  gtsummary::tbl_regression(exponentiate = TRUE,
                            label = list(
    "scale(APDQS_protein_score)" ~ "APDQS Protein score",
    "scale(age)" ~  "Age (years)",
    "scale(BMI)" ~  "BMI, (kg/m2)", 
    "factor(sex)" ~  "Sex",
    "scale(eGFR)" ~  "eGFR",
    "factor(race)" ~  "Race / ethnicity",
    "scale(energy)" ~  "Energy intake (kcals/day)")
  ) 

fit2 <- survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(Plant_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy), data = fitdata) |>
  gtsummary::tbl_regression(exponentiate = TRUE,
                            label = list(
    "scale(Plant_protein_score)" ~ "Plant Protein score",
    "scale(age)" ~  "Age (years)",
    "scale(BMI)" ~  "BMI, (kg/m2)", 
    "factor(sex)" ~  "Sex",
    "scale(eGFR)" ~  "eGFR",
    "factor(race)" ~  "Race / ethnicity",
    "scale(energy)" ~  "Energy intake (kcals/day)")
  ) 

fit3 <- survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(Meat_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy), data = fitdata) |>
  gtsummary::tbl_regression(exponentiate = TRUE,
                            label = list(
    "scale(Meat_protein_score)" ~ "Meat Protein score",
    "scale(age)" ~  "Age (years)",
    "scale(BMI)" ~  "BMI, (kg/m2)", 
    "factor(sex)" ~  "Sex",
    "scale(eGFR)" ~  "eGFR",
    "factor(race)" ~  "Race / ethnicity",
    "scale(energy)" ~  "Energy intake (kcals/day)")
  ) 

merged_table <- gtsummary::tbl_merge(
  tbls = list(fit1, fit3, fit2),
  tab_spanner = c("Model 1: APDQS Score", "Model 2: Meat Score", "Model 3: Plant Score") 
)   |>
 gtsummary::modify_table_body(~dplyr::arrange(.x, !variable %in% c("scale(APDQS_protein_score)", "scale(Meat_protein_score)", "scale(Plant_protein_score)"), variable)) |>
  gtsummary::as_gt() |>
  gt::tab_options(page.orientation = "landscape") |>
  gt::tab_options(latex.use_longtable = TRUE)


merged_table
rm(merged_table)
```

\newpage

```{r}
#| label: tbl-cox-full
#| tbl-cap: "Cox Proportional Hazards Models (fully adjusted)"
#| echo: false
#| message: false
#| cache: TRUE


# Fit model

fitdata <- scores |>
  dplyr::mutate(
        sex = factor(sex,
                       levels = c("1", "2"),
                       labels = c("Female", "Male")),
         race = factor(race,
                       levels = c("1", "2", "3", "4"),
                       labels = c("Non-Hispanic White", "Chinese American", "Black/African-American", "Hispanic")),
        diabetes = factor(diabetes,
                               levels = c("0", "1"),
                               labels = c("Normoglycemia/IFG", "Diabetes (treated or untreated)")),
        htnmeds = factor(htnmeds,
                       levels = c("0", "1"),
                       labels = c("No", "Yes")),
        lipidmeds = factor(lipidmeds,
                       levels = c("0", "1"),
                       labels = c("No", "Yes"))
  )

fit1 <- survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(APDQS_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy) + scale(smoking) + scale(SBP) + scale(HDL) + scale(cholesterol) + factor(diabetes) + factor(htnmeds) + factor(lipidmeds), data = fitdata) |>
  gtsummary::tbl_regression(exponentiate = TRUE,
                            label = list(
    "scale(APDQS_protein_score)" ~ "APDQS Protein score",
    "scale(age)" ~  "Age (years)",
    "scale(BMI)" ~  "BMI, (kg/m2)", 
    "factor(sex)" ~  "Sex",
    "scale(eGFR)" ~  "eGFR",
    "factor(race)" ~  "Race / ethnicity",
    "scale(energy)" ~  "Energy intake (kcals/day)",
    "scale(smoking)" ~ "Smoking status (pack years)",
    "scale(SBP)" ~ "Systolic blood pressure",
    "scale(HDL)" ~ "HDL",
    "scale(cholesterol)" ~ "Total cholesterol",
    "factor(diabetes)" ~ "Diabetes Status",
    "factor(htnmeds)" ~ "Takes blood pressure medication",
    "factor(lipidmeds)" ~ "Takes lipid lowering medication"
    )
  ) 

fit2 <- survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(Plant_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy) + scale(smoking) + scale(SBP) + scale(HDL) + scale(cholesterol) + factor(diabetes) + factor(htnmeds) + factor(lipidmeds), data = fitdata) |>
  gtsummary::tbl_regression(exponentiate = TRUE,
                            label = list(
    "scale(Plant_protein_score)" ~ "Plant Protein score",
    "scale(age)" ~  "Age (years)",
    "scale(BMI)" ~  "BMI, (kg/m2)", 
    "factor(sex)" ~  "Sex",
    "scale(eGFR)" ~  "eGFR",
    "factor(race)" ~  "Race / ethnicity",
    "scale(energy)" ~  "Energy intake (kcals/day)",
    "scale(smoking)" ~ "Smoking status (pack years)",
    "scale(SBP)" ~ "Systolic blood pressure",
    "scale(HDL)" ~ "HDL",
    "scale(cholesterol)" ~ "Total cholesterol",
    "factor(diabetes)" ~ "Diabetes Status",
    "factor(htnmeds)" ~ "Takes blood pressure medication",
    "factor(lipidmeds)" ~ "Takes lipid lowering medication"
    )
  ) 

fit3 <- survival::coxph(Surv(cvdhtt, as.numeric(cvdh)) ~ scale(Meat_protein_score) + scale(age) + scale(BMI) + scale(PA) + scale(eGFR) + factor(sex) + factor(race) + scale(energy) + scale(smoking) + scale(SBP) + scale(HDL) + scale(cholesterol) + factor(diabetes) + factor(htnmeds) + factor(lipidmeds), data = fitdata) |>
  gtsummary::tbl_regression(exponentiate = TRUE,
                            label = list(
    "scale(Meat_protein_score)" ~ "Meat Protein score",
    "scale(age)" ~  "Age (years)",
    "scale(BMI)" ~  "BMI, (kg/m2)", 
    "factor(sex)" ~  "Sex",
    "scale(eGFR)" ~  "eGFR",
    "factor(race)" ~  "Race / ethnicity",
    "scale(energy)" ~  "Energy intake (kcals/day)",
    "scale(smoking)" ~ "Smoking status (pack years)",
    "scale(SBP)" ~ "Systolic blood pressure",
    "scale(HDL)" ~ "HDL",
    "scale(cholesterol)" ~ "Total cholesterol",
    "factor(diabetes)" ~ "Diabetes Status",
    "factor(htnmeds)" ~ "Takes blood pressure medication",
    "factor(lipidmeds)" ~ "Takes lipid lowering medication"
    )
  ) 

merged_table <- gtsummary::tbl_merge(
  tbls = list(fit1, fit3, fit2),
  tab_spanner = c("Model 1: APDQS Score", "Model 2: Meat Score", "Model 3: Plant Score") 
)   |>
 gtsummary::modify_table_body(~dplyr::arrange(.x, !variable %in% c("scale(APDQS_protein_score)", "scale(Meat_protein_score)", "scale(Plant_protein_score)"), variable)) |>
  gtsummary::as_gt() |>
  gt::tab_options(page.orientation = "landscape") |>
  gt::tab_options(latex.use_longtable = TRUE)


merged_table
rm(merged_table)
```

:::



